#!/bin/sh

set -euo pipefail

# =========================================================================== #
# ================================= Helpers ================================= #
# =========================================================================== #

help() {
  echo "Usage: $0 SOURCE"
  echo ""
  echo "SOURCES:"
  echo "  neovim"
}

exit_with_error() {
  echo "$1" 1>&2
  exit 1
}

# =========================================================================== #
# ============================ Snapshot sources ============================= #
# =========================================================================== #

neovim() {
  local file="config/nvim/snapshot.json"
  local cache_directory="$XDG_CACHE_HOME/nvim/packer.nvim"
  local cache_file="$(mktemp -u $cache_directory/snapshot.XXXX.json)"
  local sorted_cache_file="$(mktemp -u $cache_directory/snapshot.XXXX.json)"

  mkdir -p "$cache_directory"

  nvim \
    --headless \
    -c "PackerSnapshot $cache_file" \
    -c "silent !sleep 1" \
    -c "quit"

  prettier "$cache_file" >"$sorted_cache_file"

  if [[ $ONLY_CHECK -eq 1 ]]; then
    diff "$file" "$sorted_cache_file"
  else
    cp "$sorted_cache_file" "$file"
  fi
}

# ============================================================================ #
# ============================= OPTIONS PARSING ============================== #
# ============================================================================ #

ONLY_CHECK=0

for option in "$@"; do
  case "$option" in
  --check)
    ONLY_CHECK=1
    shift
    ;;
  --*)
    exit_with_error "Unknown option: ${1%%=*}"
    ;;
  esac
done

# =========================================================================== #
# ================================ Entrypoint =============================== #
# =========================================================================== #

if [[ $# -ne 1 ]]; then
  help
  exit 1
fi

case "$1" in
neovim)
  neovim
  ;;
*)
  exit_with_error "Unknown source"
  ;;
esac
